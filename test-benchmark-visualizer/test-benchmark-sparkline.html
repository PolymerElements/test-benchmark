<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<script src="../../d3/d3.js"></script>
<link rel="import" href="../../paper-styles/paper-styles.html">
<link rel="import" href="../../iron-resizable-behavior/iron-resizable-behavior.html">

<!--
This element visualizes the data available in a provide `PerformanceTest`
instance. The current average and standard deviation of all available test
run results is displayed at the top of the sparkline, and a series of columns
are displayed to demonstrate the relative difference of each test run result.

### Styling

Custom property                           | Description                                      | Default
------------------------------------------|--------------------------------------------------|------------------------
`--test-benchmark-sparkline-light`        | Background color at the top of the sparkline.    | `--paper-blue-grey-500`
`--test-benchmark-sparkline-dark`         | Background color at the bottom of the sparkline. | `--paper-blue-grey-700`
`--test-benchmark-sparkline-axis-color`   | The axis color for the sparkline.                | `--paper-blue-grey-500`
`--test-benchmark-sparkline-column-color` | The column color for the sparkline.              | `--paper-blue-grey-100`

@demo demo/index.html
-->

<dom-module id="test-benchmark-sparkline">
  <template>
    <style>
      :host {
        @apply(--layout);
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--paper-font-common-base);
        @apply(--shadow-elevation-2dp);

        box-sizing: border-box;
        border-radius: 2px;
        overflow: hidden;


        color: #fff;

        background-color: var(--test-benchmark-sparkline-light, --paper-blue-grey-500);
      }

      #chart {
        flex: 1 0 60px;
        padding: 1em 1em;
        box-sizing: border-box;
        background-color: var(--test-benchmark-sparkline-dark, --paper-blue-grey-700);
      }

      .x-axis-path {
        stroke-width: 1px;
        stroke: var(--test-benchmark-sparkline-axis-color, --paper-blue-grey-500);
      }

      .column {
        fill: var(--test-benchmark-sparkline-column-color, --paper-blue-grey-100);
      }

      #stats {
        padding: 0.5em;
        text-align: center;
      }

      #stats h1 {
        font-size: 18px;
        font-weight: normal;
      }

      #stats h2 > span {
        font-size: 16px;
        font-weight: normal;
      }

      #stats * {
        margin: 8px 0;
      }

      #stats :first-child {
        margin-top: 0;
      }

      #stats :last-child {
        margin-bottom: 0;
      }

      svg {
        width: 100%;
        height: 30px;
      }
    </style>

    <div id="stats">
      <h1>[[name]]</h1>
      <h2>[[average]]ms <span>Â± [[fixedStandardDeviation]]</span></h2>
    </div>
    <div id="chart"></div>
  </template>
</dom-module>
<script>
Polymer({
  is: 'test-benchmark-sparkline',

  behaviors: [
    Polymer.IronResizableBehavior
  ],

  properties: {

    /**
     * The `PerformanceTest` instance that this sparkline is visualizing.
     */
    test: {
      type: Object,
      observer: 'update'
    },

    /**
     * The name of the test being visualized.
     */
    name: {
      type: String,
      readOnly: true
    },

    /**
     * The avarage of all run results for the test being visualized.
     */
    average: {
      type: Number,
      readOnly: true
    },

    /**
     * The fixed standard deviation for all results of the test being
     * visualized.
     */
    fixedStandardDeviation: {
      type: Number,
      readOnly: true
    }
  },

  listeners: {
    'iron-resize': 'update'
  },

  created: function() {
    this.x = d3.scale.linear();
    this.y = d3.scale.linear();

    this.svg = d3.select(
      document.createElementNS('http://www.w3.org/2000/svg', 'svg')
    );

    this.xAxisPath = this.svg
      .append('path')
      .classed('x-axis-path', true);
  },

  ready: function() {
    Polymer.dom(this.$.chart).appendChild(this.svg.node());
  },

  /**
   * Re-renders the sparkline based on the current set of data available
   * in the associated `PerformanceTest` instance.
   */
  update: function() {
    var rect = this.svg.node().getBoundingClientRect();
    var extent = d3.extent(this.test.data, function(datum) {
      return datum.elapsed;
    });

    if (!this.test.data.length) {
      extent = [0, 1];
    }

    var middle = extent[0] + (extent[1] - extent[0]) / 2;
    //var absoluteMaximum = Math.max(Math.abs(extent[0]), Math.abs(extent[1]));
    //var middle = 

    this._setName(this.test.name);
    this._setAverage(this.test.fixedAverage);
    this._setFixedStandardDeviation(this.test.fixedStandardDeviation);

    this.x
      .range([0, rect.width])
      .domain([0, this.test.totalRuns]);

    this.y
      .range([rect.height, 0])
      .domain([extent[0], extent[1]]);

    this.xAxisPath
      .datum(this.x.domain())
      .attr('d',
        d3.svg
        .line()
        .x(function(datum) {
          return this.x(datum);
        }.bind(this))
        .y(rect.height / 2));

    var columns = this.svg
      .selectAll('.column')
      .data(this.test.series);

    columns
      .enter()
      .append('rect')
      .attr('rx', '1')
      .attr('ry', '1')
      .classed('column', true)
      .classed('test-benchmark-sparkline', true);

    columns
      .attr('x', function(datum, index) {
        return this.x(index);
      }.bind(this))
      .attr('y', function(datum) {
        if (datum > middle) {
          return this.y(datum);
        }

        return this.y(middle);
      }.bind(this))
      .attr('width', function(datum, index) {
        return this.x(index + 0.85) - this.x(index);
      }.bind(this))
      .attr('height', function(datum) {
        if (datum > middle) {
          return this.y(middle) - this.y(datum);
        }

        return this.y(datum) - this.y(middle);
      }.bind(this));

    columns
      .exit()
      .remove();
  }
});
</script>
